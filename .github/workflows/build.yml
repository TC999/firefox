name: ç¼–è¯‘ Firefox

on:
  workflow_dispatch:
    inputs:
      linux:
        type: boolean
        description: 'Linux'
      windows:
        type: boolean
        description: 'Windows'
      release:
        type: boolean
        description: 'å‘è¡Œ'

jobs:
  Linux:
    if: ${{ inputs.linux }}
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      LANG: zh_CN.UTF-8
      LANGUAGE: zh_CN:zh
      LC_ALL: zh_CN.UTF-8

    steps:
      #- name: æ£€å‡ºæºç 
      # uses: actions/checkout@v4
      - name: æ±‰åŒ–
        run: |
          sudo apt-get update
          sudo apt-get install language-pack-zh-hans
          
      - name: æ˜¾ç¤ºé…ç½®
        run: |
          echo "è­¦å‘Šâš "
          echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
          echo -e "å·²çŸ¥CPUå‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
          echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
          echo -e "CPUå‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
          echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

      - name: ç£ç›˜æ¸…ç†
        uses: rokibhasansagar/slimhub_actions@v23.44.6

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y curl python3 python3-pip git 

      - name: å¼•å¯¼ç¯å¢ƒï¼ˆBootstrapï¼‰
        run: |
          curl -LO https://raw.githubusercontent.com/mozilla-firefox/firefox/refs/heads/main/python/mozboot/bin/bootstrap.py
          python3 bootstrap.py --no-interactive

      - name: Install Rust
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y
          source $HOME/.cargo/env
          rustc --version
          cargo --version

      - name: æ‹‰å–æœ€æ–°ä»£ç 
        run: |
          cd firefox
          git pull

      - name: ç¼–è¯‘ Firefox
        run: |
          cd firefox
          ./mach build

      - name: æ˜¾ç¤ºæ„å»ºç»“æœ
        run: |
          if [ -f "firefox/obj-x86_64-pc-linux-gnu/dist/bin/firefox" ]; then
            echo "ğŸ‰ Firefox ç¼–è¯‘æˆåŠŸï¼"
          else
            echo "âŒ Firefox ç¼–è¯‘å¤±è´¥ï¼"
            exit 1
          fi

      #- name: å‹ç¼©ä¸º tar.xz åŒ…
      #  run: |
      #    tar cjvf firefox.tar.xz firefox/obj-*/dist/bin

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: firefox-linux-build
          path: |
            firefox/obj-*/dist/

  Windows:
    if: ${{ inputs.windows }}
    runs-on: windows-2022
    timeout-minutes: 180
    env:
      MOZILLA_SOURCE_DIR: C:\mozilla-source
      CARGO_TERM_COLOR: always
    steps:
      #- name: æ£€å‡º workflow ä»“åº“
      #  uses: actions/checkout@v4
      - name: ä¸‹è½½æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯è„šæœ¬
        run: |
          curl https://raw.githubusercontent.com/TC999/firefox/refs/heads/main/info.ps1 -o info.ps1
  
      - name: æŸ¥çœ‹ç³»ç»Ÿç¡¬ä»¶ä¿¡æ¯
        shell: pwsh
        continue-on-error: true
        run: |
          .\info.ps1
  
      #- name: åˆ†åŒºä¿¡æ¯
      #  shell: pwsh
      #  run: Get-Partition
      
      - name: ä¸‹è½½æ¸…ç†è„šæœ¬
        run: |
          curl https://raw.githubusercontent.com/TC999/firefox/refs/heads/main/clean.ps1 -o clean.ps1
  
      - name: æ‰©å®¹
        shell: pwsh
        continue-on-error: true
        run: |
          .\clean.ps1
  
      - name: å®‰è£… Chocolateyï¼ˆåŒ…ç®¡ç†å™¨ï¼‰
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
  
      - name: å®‰è£… wget
        continue-on-error: true 
        run: |
          choco install -y wget
  
      - name: å®‰è£… Python
        uses: actions/setup-python@v5.6.0
        with:
          # Version range or exact version of Python or PyPy to use, using SemVer's version range syntax. Reads from .python-version if unset.
          python-version: 3.11
  
      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
  
      - name: éªŒè¯ä¾èµ–
        run: |
          git --version
          python --version
          pip --version
          wget --version
  
      - name: ä¸‹è½½å¹¶å®‰è£… MozillaBuild
        run: |
          $url = "https://ftp.mozilla.org/pub/mozilla/libraries/win32/MozillaBuildSetup-Latest.exe"
          $output = "$env:TEMP\MozillaBuildSetup.exe"
          Invoke-WebRequest $url -OutFile $output
          Start-Process -Wait -NoNewWindow -FilePath $output -ArgumentList '/S'
  
      - name: åˆ›å»ºæºç ç›®å½•
        run: |
          New-Item -ItemType Directory -Force -Path "C:\mozilla-source"
  
      - name: ä¸‹è½½ Firefox bootstrap.py
        working-directory: C:\mozilla-source
        run: |
          wget https://raw.githubusercontent.com/mozilla-firefox/firefox/refs/heads/main/python/mozboot/bin/bootstrap.py
  
      - name: è¿è¡Œ bootstrap.py å¼•å¯¼æºç å’Œä¾èµ–
        working-directory: C:\mozilla-source
        run: |
          python bootstrap.py --no-interactive --application-choice=browser
  
      - name: æ£€å‡º Firefox æºç ï¼ˆcentral åˆ†æ”¯ï¼‰
        working-directory: C:\mozilla-source
        run: |
          if (-Not (Test-Path "C:\mozilla-source\firefox")) {
            git clone https://github.com/mozilla/gecko-dev.git firefox
          }
          cd firefox
          git fetch origin
          git pull
  
      - name: æ„å»º Firefox
        working-directory: C:\mozilla-source\firefox
        run: |
          .\mach.cmd build
  
      - name: è¾“å‡ºæ„å»ºäº§ç‰©ç›®å½•
        working-directory: C:\mozilla-source\firefox
        run: |
          dir obj-*\dist\bin
  
      # å¯é€‰: ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼  Firefox å¯æ‰§è¡Œæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: firefox-windows-build
          path: |
            C:\mozilla-source\firefox\obj-*\dist

  Release:
    if: ${{ inputs.release }}
    needs: [ Linux, Windows ]
    runs-on: ubuntu-latest
    steps:
      - name: ä¸‹è½½ç¼–è¯‘äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: å‹ç¼©ä¸º tar.xz(Linux)
        run: |
          cd artifacts/firefox-linux-build/obj-*/dist
          mv bin firefox
          tar cjvf ../../../../firefox-linux.tar.xz firefox

      - name: å‹ç¼©ä¸º tar.xz(Windows)
        run: |
          cd artifacts/firefox-windows-build/obj-*/dist
          mv bin firefox
          tar cjvf ../../../../firefox-windows.tar.xz firefox

      - name: è·å–å½“å‰æ—¶é—´
        run: |
          echo "BUILD_DATE=$( TZ='Asia/Shanghai' date +"%Y%m%d%H%M%S")" >> $GITHUB_ENV
          echo "ç¼–è¯‘æ—¶é—´ï¼š${{ env.BUILD_DATE }}"
      
      - name: å‘è¡Œ
        uses: softprops/action-gh-release@v2.2.2
        with:
          name: ${{ env.BUILD_DATE }}
          tag_name: ${{ env.BUILD_DATE }}
          #body: ${{ inputs.release_body }}
          draft: false
          #prerelease: ${{ inputs.is_prerelease }}
          make_latest: true
          files: |
            firefox-linux.tar.xz
            firefox-windows.tar.xz

